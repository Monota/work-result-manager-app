<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout">
<head>
<meta charset="UTF-8" />
<meta th:name="_csrf" th:content="${_csrf.token}"/>
<title>成果一覧</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.js"></script>
<script th:inline="javascript">
$(document).ready(function(){
	$('tr').on('dblclick', function() {
		$('#createButton').hide();
		$('#editButton').show();
		$('#workDate').prop('readonly', true);
		$('#itemTypeName').prop('readonly', true);
		$('#itemIsNew').prop('readonly', true);
		$('#itemUnitPrice').prop('readonly', true);
		$('#workDate').val($(this).find('td,th').eq(0).text());
		$('#itemTypeName').val($(this).find('td,th').eq(1).text());
		if ($(this).find('td,th').eq(2).text() == "○") {
			$('#itemIsNew').prop("checked", true);
		} else {
			$('#itemIsNew').prop("checked", false);
		}
		$('#itemUnitPrice').val($(this).find('td,th').eq(3).text());
		$('#itemQuantity').val($(this).find('td,th').eq(4).text());
		$('.ui.modal').modal('show');
	});
	$('#newItemButton').on('click', function() {
		$('#createButton').show();
		$('#editButton').hide();
		$('#workDate').prop('readonly', false);
		$('#itemTypeName').prop('readonly', false);
		$('#itemIsNew').prop('readonly', false);
		$('#itemUnitPrice').prop('readonly', false);
		$('#workDate').val('');
		$('#itemTypeName').val('');
		$('#itemIsNew').prop("checked", false);
		$('#itemUnitPrice').val('');
		$('#itemQuantity').val('');
		$('.ui.modal').modal('show');
	});
	$('tr > td > button').on('click', function() {
		var row = this.parentNode.parentNode;
		var workDate = $(row).find('td').eq(0).text();
		var itemTypeName = $(row).find('td').eq(1).text();
		var itemIsNew = $(row).find('td').eq(2).text() == "○";
		var itemUnitPrice = $(row).find('td').eq(3).text();
		var itemQuantity = $(row).find('td').eq(4).text();
		var token = $("meta[name='_csrf']").attr("content");
		var postForm = $('<form/>', {'action': '/work/list/save', 'method': 'post'});
		postForm.append($('<input/>', {'type': 'hidden', 'name': 'workDate', 'value': workDate}));
		postForm.append($('<input/>', {'type': 'hidden', 'name': 'itemTypeName', 'value': itemTypeName}));
		postForm.append($('<input/>', {'type': 'hidden', 'name': 'itemIsNew', 'value': itemIsNew}));
		postForm.append($('<input/>', {'type': 'hidden', 'name': 'itemUnitPrice', 'value': itemUnitPrice}));
		postForm.append($('<input/>', {'type': 'hidden', 'name': 'itemQuantity', 'value': itemQuantity}));
		postForm.append($('<input/>', {'type': 'hidden', 'name': 'mode', 'value': 'del'}));
		postForm.append($('<input/>', {'type': 'hidden', 'name': '_csrf', 'value': token}));
		postForm.appendTo(document.body);
		postForm.submit();
	});
});
function submitFormEdit() {
	$('#mode').val('edit');
	$('#editForm').submit();
}
function submitFormDelete() {
	$('#mode').val('del');
	$('#editForm').submit();
}
function submitFormCreate() {
	$('#mode').val('new');
	$('#editForm').submit();
}
</script>
<style>
.container {
	margin-top: 30px;
}
</style>
</head>
<body>
	<div class="ui container">
		<row th:if="${Message} != null">
			<p class="ui positive message">完了しました。</p>
		</row>
		<row th:if="${ErrorMessage} != null">
			<p class="ui error message">
				入力エラーがあります。<br>画面から正しい値を入力してください。
			</p>
		</row>
	</div>
	<div class="ui container">
		<row>
			<button class="ui labeled icon positive button" id="newItemButton">
				<i class="edit icon"></i>追加
			</button>
		</row>
	</div>
	<div class="ui container">
		<row th:unless="${#lists.isEmpty(workItems)}">
			<table class="ui celled table">
				<thead>
					<tr>
						<th>日付</th>
						<th>種類</th>
						<th>新品</th>
						<th>単価</th>
						<th>数量</th>
						<th>小計</th>
						<th>&nbsp;</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="wi : ${workItems}">
						<td th:text="${#dates.format(wi.workDate,'yyyy-MM-dd')}">2018-04-01</td>
						<td th:text="${{wi.itemTypeName}}">テスト1</td>
						<td th:text="${{wi.itemIsNew}} ? '○' : ''">○</td>
						<td th:text="${{wi.itemUnitPrice}}">3.0</td>
						<td th:text="${{wi.itemQuantity}}">2</td>
						<td th:text="${{wi.itemUnitPrice}} * ${{wi.itemQuantity}}">6.0</td>
						<td><button class="tiny negative ui basic button"><i class="delete icon"></i>削除</button></td>
					</tr>
				</tbody>
			</table>
		</row>
	</div>
	</div>
	<div class="ui modal">
		<i class="close icon"></i>
		<div class="header">編集</div>
		<div class="content">
			<form id="editForm" class="ui form" method="POST" action="/work/list/save" th:action="@{/work/list/save}" th:object="${workItemForm}">
				<div class="field">
					<label for="workDate">日付</label>
					<input type="text" class="ui input" id="workDate" th:field="*{workDate}" readonly="readonly" />
				</div>
				<div class="field">
					<label for="itemTypeName">種類</label>
					<input type="text" class="ui input" id="itemTypeName" th:field="*{itemTypeName}" readonly="readonly" />
				</div>
				<div class="field">
					<label for="itemIsNew">新品</label>
					<div class="ui toggle checkbox">
						<input tabindex="0" class="hidden" type="checkbox" id="itemIsNew" th:field="*{itemIsNew}" readonly="readonly">
					</div>
				</div>
				<div class="field">
					<label for="itemUnitPrice">単価</label>
					<input type="text" class="ui input" id="itemUnitPrice" th:field="*{itemUnitPrice}" readonly="readonly" />
				</div>
				<div class="field">
					<label for="itemQuantity">数量</label>
					<input type="text" class="ui input" id="itemQuantity" th:field="*{itemQuantity}" />
				</div>
				<input type="hidden" id="mode" th:field="*{mode}" />
			</form>
		</div>
		<div class="actions">
			<div class="ui positive button" id="createButton">作成</div>
			<div class="ui primary button" id="editButton">更新</div>
			<div class="ui cancel button">閉じる</div>
		</div>
	</div>
</body>
</html>
